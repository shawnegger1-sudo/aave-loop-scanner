<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Aave Loop Scanner</title>
</head>
<body style="font-family:Arial; padding:20px;">
  <h2>Aave Loop Scanner</h2>
  <button onclick="run()">Run analysis</button>
  <pre id="out" style="margin-top:15px;"></pre>

<script>
async function run() {
  const out = document.getElementById("out");
  out.textContent = "Fetching Aave data...";

  try {
    const res = await fetch("https://api.v3.aave.com/graphql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        query: `
          query {
            markets(request:{ chainIds:[1] }) {
              name
              supplyReserves {
                underlyingToken { symbol }
                supplyInfo { apy }
              }
              borrowReserves {
                underlyingToken { symbol }
                borrowInfo { apy }
              }
            }
          }
        `
      })
    });

    const json = await res.json();
    const L = 3;
    let rows = [];

    for (const m of json.data.markets) {
      for (const s of m.supplyReserves) {
        const sApy = Number(s.supplyInfo?.apy);
        if (!isFinite(sApy)) continue;

        for (const b of m.borrowReserves) {
          if (b.underlyingToken.symbol !== s.underlyingToken.symbol) continue;
          const bApy = Number(b.borrowInfo?.apy);
          if (!isFinite(bApy)) continue;

          const net = sApy * L - bApy * (L - 1);
          rows.push(`${m.name} | ${s.underlyingToken.symbol} | ${(net*100).toFixed(2)}%`);
        }
      }
    }

    rows.sort((a,b)=>parseFloat(b.split("%")[0])-parseFloat(a.split("%")[0]));
    out.textContent = "Top 15 same-asset loops (3x):\n\n" + rows.slice(0,15).join("\n");

  } catch (e) {
    out.textContent = "Error: " + e.message;
  }
}
</script>
</body>
</html>
