<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Aave Loop Scanner</title>
</head>
<body style="font-family:Arial; padding:20px;">
  <h2>Aave Loop Scanner (ETH mainnet)</h2>

  <button onclick="run()" style="padding:10px 14px; font-size:16px;">
    Run analysis
  </button>

  <pre id="out" style="margin-top:15px; white-space:pre-wrap;"></pre>

<script>
async function run() {
  const out = document.getElementById("out");
  out.textContent = "Fetching Aave data...";

  try {
    const res = await fetch("https://api.v3.aave.com/graphql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        query: `
          query {
            aaveV3Pools {
              chainId
              name
              reserves {
                symbol
                supplyAPY
                variableBorrowAPY
              }
            }
          }
        `
      })
    });

    const json = await res.json();

    if (json.errors) {
      out.textContent =
        "GraphQL error:\\n\\n" +
        json.errors.map(e => e.message).join("\\n");
      return;
    }

    const pools = json.data?.aaveV3Pools;
    if (!pools) {
      out.textContent =
        "No data returned:\\n\\n" +
        JSON.stringify(json, null, 2);
      return;
    }

    const L = 3; // 3x leverage
    const rows = [];

    for (const pool of pools) {
      if (pool.chainId !== 1) continue; // Ethereum only

      for (const r of pool.reserves) {
        const sApy = Number(r.supplyAPY);
        const bApy = Number(r.variableBorrowAPY);

        if (!isFinite(sApy) || !isFinite(bApy)) continue;

        const net = sApy * L - bApy * (L - 1);

        rows.push({
          market: pool.name,
          asset: r.symbol,
          net
        });
      }
    }

    rows.sort((a,b)=>b.net-a.net);

    out.textContent =
      "Top same-asset loops (3x leverage):\\n\\n" +
      rows.slice(0,15).map(r =>
        `${r.market} | ${r.asset} | ${(r.net*100).toFixed(2)}%`
      ).join("\\n");

  } catch (e) {
    out.textContent = "Browser/network error:\\n" + e.message;
  }
}
</script>
</body>
</html>
