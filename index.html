<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Aave Loop Scanner (Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="font-family:Arial, sans-serif; padding:20px;">
  <h2>Aave Loop Scanner (Ethereum)</h2>
  <div style="color:#555; margin-bottom:10px;">
    Version: <b>0.3</b> (DeFiLlama REST API, no GraphQL)
  </div>

  <button onclick="run()" style="padding:10px 14px; font-size:16px; cursor:pointer;">
    Run analysis
  </button>

  <pre id="out" style="
    margin-top:15px;
    white-space:pre-wrap;
    background:#f6f8fa;
    padding:12px;
    border-radius:8px;
  "></pre>

<script>
async function run() {
  const out = document.getElementById("out");
  out.textContent = "Fetching DeFiLlama lending data...";

  try {
    const res = await fetch("https://yields.llama.fi/lendBorrow", { cache: "no-store" });
    const rows = await res.json();

    // IMPORTANT: DeFiLlama returns an ARRAY directly (not { data: [...] })
    if (!Array.isArray(rows)) {
      out.textContent =
        "Unexpected response (NOT an array):\n\n" +
        JSON.stringify(rows, null, 2);
      return;
    }

    // Show a small debug header so you can confirm the code path is correct
    const header =
      `Received ${rows.length.toLocaleString()} rows from DeFiLlama.\n` +
      `Filtering: project=aave-v3, chain=Ethereum, has apyBase & apyBaseBorrow.\n\n`;

    // Filter: Aave V3 on Ethereum, require both supply & borrow base APYs
    const filtered = rows.filter(r =>
      r.project === "aave-v3" &&
      r.chain === "Ethereum" &&
      typeof r.apyBase === "number" &&
      typeof r.apyBaseBorrow === "number"
    );

    if (!filtered.length) {
      out.textContent =
        header +
        "No matching Aav
