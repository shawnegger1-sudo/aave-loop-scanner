<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Aave Loop Scanner (Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family:Arial, sans-serif; padding:20px;">

<h2>Aave Loop Scanner (Ethereum)</h2>
<p>
  One button. Uses DeFiLlama lending API (stable, public).
  Same-asset loops, 3× leverage.
</p>

<button onclick="run()" style="padding:10px 14px; font-size:16px;">
  Run analysis
</button>

<pre id="out" style="
  margin-top:15px;
  white-space:pre-wrap;
  background:#f6f8fa;
  padding:12px;
  border-radius:8px;
"></pre>

<script>
async function run() {
  const out = document.getElementById("out");
  out.textContent = "Fetching DeFiLlama lending data...";

  try {
    const res = await fetch("https://yields.llama.fi/lendBorrow");
    const rows = await res.json();

    if (!Array.isArray(rows)) {
      out.textContent =
        "Unexpected response (not an array):\n\n" +
        JSON.stringify(rows, null, 2);
      return;
    }

    // Filter: Aave V3, Ethereum, valid borrow + supply
    const filtered = rows.filter(r =>
      r.project === "aave-v3" &&
      r.chain === "Ethereum" &&
      typeof r.apyBase === "number" &&
      typeof r.apyBaseBorrow === "number"
    );

    const L = 3; // leverage
    const results = [];

    for (const r of filtered) {
      const supplyApy = r.apyBase / 100;
      const borrowApy = r.apyBaseBorrow / 100;

      const net = supplyApy * L - borrowApy * (L - 1);

      results.push({
        asset: r.symbol || r.mintedCoin || "UNKNOWN",
        net,
        supplyApy,
        borrowApy
      });
    }

    results.sort((a,b)=>b.net - a.net);

    if (!results.length) {
      out.textContent = "No valid Aave V3 Ethereum rows found.";
      return;
    }

    out.textContent =
      "Top same-asset loops (3× leverage)\n\n" +
      results.slice(0,15).map(r =>
        `${r.asset} | net ${(r.net*100).toFixed(2)}% ` +
        `(s ${(r.supplyApy*100).toFixed(2)}% / b ${(r.borrowApy*100).toFixed(2)}%)`
      ).join("\n");

  } catch (e) {
    out.textContent = "Error:\n" + e.message;
  }
}
</script>

</body>
</html>
